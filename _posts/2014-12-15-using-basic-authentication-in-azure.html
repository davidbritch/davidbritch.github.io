---
layout: post
title: Using basic authentication in an Azure Cloud Service
date: '2014-12-15T17:35:00.000Z'
author: David Britch
tags:
- Azure
- C#
modified_time: '2014-12-15T17:40:45.583Z'
blogger_id: tag:blogger.com,1999:blog-8265682915956744370.post-8638628153708330617
blogger_orig_url: https://dbritch.blogspot.com/2014/12/using-basic-authentication-in-azure.html
---

<p>I recently had a requirement to use transport security with basic authentication in a web service hosted in Azure. Basic authentication is a mechanism for a HTTP user agent to provide credentials when making a request to the server, and is supported by all major browsers and servers. It doesn’t require cookies, session identifiers, or login pages. Instead it uses a static, standard HTTP header which means that no handshakes need to be performed.</p> <p>IIS web servers provide basic authentication against Windows accounts on the server or through active directory. This situation is further complicated in services hosted in Azure. The following code shows how transport security with basic authentication can be specified in a web.config file.</p> <p> <div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:227a1901-ab21-4635-a4aa-346294f1bd96" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"><pre style=" width: 808px; height: 166px;background-color:White;overflow: visible;"><div><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: #008080;">1</span> <span style="color: #0000FF;">&lt;</span><span style="color: #800000;">bindings</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">2</span> <span style="color: #000000;">  </span><span style="color: #0000FF;">&lt;</span><span style="color: #800000;">basicHttpsBinding</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">3</span> <span style="color: #000000;">    </span><span style="color: #0000FF;">&lt;</span><span style="color: #800000;">binding </span><span style="color: #FF0000;">name</span><span style="color: #0000FF;">=&quot;TransportSecurity&quot;</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">4</span> <span style="color: #000000;">      </span><span style="color: #0000FF;">&lt;</span><span style="color: #800000;">security </span><span style="color: #FF0000;">mode</span><span style="color: #0000FF;">=&quot;Transport&quot;</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">5</span> <span style="color: #000000;">        </span><span style="color: #0000FF;">&lt;</span><span style="color: #800000;">transport </span><span style="color: #FF0000;">clientCredentialType</span><span style="color: #0000FF;">=&quot;Basic&quot;</span><span style="color: #0000FF;">/&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">6</span> <span style="color: #000000;">      </span><span style="color: #0000FF;">&lt;/</span><span style="color: #800000;">security</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">7</span> <span style="color: #000000;">    </span><span style="color: #0000FF;">&lt;/</span><span style="color: #800000;">binding</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">8</span> <span style="color: #000000;">  </span><span style="color: #0000FF;">&lt;/</span><span style="color: #800000;">basicHttpsBinding</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">9</span> <span style="color: #000000;"></span><span style="color: #0000FF;">&lt;/</span><span style="color: #800000;">bindings</span><span style="color: #0000FF;">&gt;</span></div></pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div></p><p>However, when you run an Azure cloud service with this configuration you’ll receive the following error message:</p><blockquote><strong>The authentication schemes configured on the host ('Anonymous') do not allow those configured on the binding 'BasicHttpsBinding' ('Basic').&nbsp; Please ensure that the SecurityMode is set to Transport or TransportCredentialOnly.&nbsp; Additionally, this may be resolved by changing the authentication schemes for this application through the IIS management tool, through the ServiceHost.Authentication.AuthenticationSchemes property, in the application configuration file at the &lt;serviceAuthenticationManager&gt; element, by updating the ClientCredentialType property on the binding, or by adjusting the AuthenticationScheme property on the HttpTransportBindingElement.</strong></blockquote><p>The initial problem is that basic authentication is unavailable by default for Azure web roles. It can be enabled either by enabling RDP on the virtual machine that the service is running on, RDPing in and adding basic authentication to IIS and then enabling it. Alternatively you could write a Powershell script to install basic authentication, and configure it to run from your VS solution when the web role starts up. Then you need to create a Windows account in the virtual machine that will be used during basic authentication.</p><p>This solution was not ideal. Moving forwards the service could have many different users, and I didn’t like the thought of having to create Windows accounts for each user. Furthermore, I’m a firm believer in trying to keep web services as provider agnostic as possible, in order to reduce problems if the service needs to be moved to another provider.</p><p>An alternative solution would be to use a different basic authentication module, provided by a third party. This is also not ideal, as it involves additional effort in identifying a suitable third party module to use, and then much time thoroughly testing it.</p><p>In this blog post I’ll outline my solution to this problem, which is to implement your own basic authentication mechanism. Basic authentication uses a simple protocol:</p><ol><li>The “username:password” format is used to combine username and password into one string.</li><br /><li>The resulting string is then base64 encoded.</li><br /><li>The encoding string is sent to the server in an Authorization header sent with the web request:</li></ol><blockquote><strong>Authorization: Basic &lt;base64 encoded username:password goes here&gt;</strong></blockquote><br /><h3>Implementation</h3><p>My solution is in three parts:</p><ol><li>Configure the service to use transport security but no authentication.</li><li>In the service, intercept all web requests and parse out the Authorization header that contains the basic authentication credentials. The extracted credentials can then be compared against the actual credentials.</li><li>In the client, intercept all web requests and add an appropriate Authorization header using the convention specified for basic authentication.</li></ol><p>The following code shows how to configure the service to use transport security but not authentication.</p><div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:30974079-08dd-4e23-8540-977f232e2fe6" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"><pre style=" width: 808px; height: 162px;background-color:White;overflow: visible;"><div><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: #008080;">1</span> <span style="color: #000000;">    </span><span style="color: #0000FF;">&lt;</span><span style="color: #800000;">bindings</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">2</span> <span style="color: #000000;">      </span><span style="color: #0000FF;">&lt;</span><span style="color: #800000;">basicHttpsBinding</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">3</span> <span style="color: #000000;">        </span><span style="color: #0000FF;">&lt;</span><span style="color: #800000;">binding </span><span style="color: #FF0000;">name</span><span style="color: #0000FF;">=&quot;TransportSecurity&quot;</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">4</span> <span style="color: #000000;">          </span><span style="color: #0000FF;">&lt;</span><span style="color: #800000;">security </span><span style="color: #FF0000;">mode</span><span style="color: #0000FF;">=&quot;Transport&quot;</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">5</span> <span style="color: #000000;">            </span><span style="color: #0000FF;">&lt;</span><span style="color: #800000;">transport </span><span style="color: #FF0000;">clientCredentialType</span><span style="color: #0000FF;">=&quot;None&quot;</span><span style="color: #0000FF;">/&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">6</span> <span style="color: #000000;">          </span><span style="color: #0000FF;">&lt;/</span><span style="color: #800000;">security</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">7</span> <span style="color: #000000;">        </span><span style="color: #0000FF;">&lt;/</span><span style="color: #800000;">binding</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">8</span> <span style="color: #000000;">      </span><span style="color: #0000FF;">&lt;/</span><span style="color: #800000;">basicHttpsBinding</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">9</span> <span style="color: #000000;">    </span><span style="color: #0000FF;">&lt;/</span><span style="color: #800000;">bindings</span><span style="color: #0000FF;">&gt;</span></div></pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div></p><p>To intercept web requests to the service I created a class called <strong>BasicAuthenticationManager</strong> that derives from the <a href="http://msdn.microsoft.com/en-us/library/system.servicemodel.serviceauthorizationmanager(v=vs.110).aspx">ServiceAuthorizationManager</a> class, which provides authorization access checking for service operations. This class overrides the <a href="http://msdn.microsoft.com/en-us/library/ms585787(v=vs.110).aspx">CheckAccessCore</a> method which checks authorization for the given operation context. In this method you can obtain the headers for the web request, and you can then parse out the Authorization header. The following code example shows this.</p><div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:373a5754-5f42-42f6-bd7c-bdadba8ba92a" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"><pre style=" width: 808px; height: 280px;background-color:White;overflow: visible;"><div><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: #008080;"> 1</span> <span style="color: #0000FF;">protected</span><span style="color: #000000;"> </span><span style="color: #0000FF;">override</span><span style="color: #000000;"> </span><span style="color: #0000FF;">bool</span><span style="color: #000000;"> CheckAccessCore(OperationContext operationContext)<br /></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{<br /></span><span style="color: #008080;"> 3</span> <span style="color: #000000;">    var authHeader </span><span style="color: #000000;">=</span><span style="color: #000000;"> WebOperationContext.Current.IncomingRequest.Headers[</span><span style="color: #800000;">&quot;</span><span style="color: #800000;">Authorization</span><span style="color: #800000;">&quot;</span><span style="color: #000000;">];<br /></span><span style="color: #008080;"> 4</span> <span style="color: #000000;"><br /></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">    </span><span style="color: #0000FF;">if</span><span style="color: #000000;"> (</span><span style="color: #000000;">!</span><span style="color: #0000FF;">string</span><span style="color: #000000;">.IsNullOrWhiteSpace(authHeader))<br /></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">    {<br /></span><span style="color: #008080;"> 7</span> <span style="color: #000000;">        </span><span style="color: #0000FF;">if</span><span style="color: #000000;"> (authHeader.StartsWith(</span><span style="color: #800000;">&quot;</span><span style="color: #800000;">Basic</span><span style="color: #800000;">&quot;</span><span style="color: #000000;">))<br /></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">        {<br /></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">            var credentials </span><span style="color: #000000;">=</span><span style="color: #000000;"> ASCIIEncoding.ASCII.GetString(Convert.FromBase64String(authHeader.Substring(</span><span style="color: #800080;">6</span><span style="color: #000000;">))).Split(</span><span style="color: #800000;">'</span><span style="color: #800000;">:</span><span style="color: #800000;">'</span><span style="color: #000000;">);<br /></span><span style="color: #008080;">10</span> <span style="color: #000000;">            <br /></span><span style="color: #008080;">11</span> <span style="color: #000000;">            </span><span style="color: #008000;">//</span><span style="color: #008000;"> Compare credentials against stored encrypted credentials<br /></span><span style="color: #008080;">12</span> <span style="color: #008000;">            </span><span style="color: #008000;">//</span><span style="color: #008000;"> If equal return true, otherwise false</span><span style="color: #008000;"><br /></span><span style="color: #008080;">13</span> <span style="color: #008000;"></span><span style="color: #000000;">        }<br /></span><span style="color: #008080;">14</span> <span style="color: #000000;">    }<br /></span><span style="color: #008080;">15</span> <span style="color: #000000;">}</span></div></pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div><p>The logic is straight forward: The Authorization header is extracted from the web request, and then the credentials are extracted from the Authorization header. The credentials can then be validated using your chosen approach (such as comparing them against encrypted credentials stored in configuration). If the credentials are valid, then return <strong>true</strong>. Otherwise return <strong>false</strong>, or throw the exception of your choosing to prevent the service operation being executed.</p><p>The service must then be configured to use the <strong>BasicAuthenticationManager </strong>class. This can be accomplished by adding a <strong>serviceAuthorization</strong> element to your web.config. Note that the format for specifying the class is AssemblyNamespace.Classname, AssemblyNamespace.</p><div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:6e31efec-75a3-4528-aa01-785a0aad5810" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"><pre style=" width: 808px; height: 334px;background-color:White;overflow: visible;"><div><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: #008080;"> 1</span> <span style="color: #0000FF;">&lt;?</span><span style="color: #FF00FF;">xml version=&quot;1.0&quot;</span><span style="color: #0000FF;">?&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;"> 2</span> <span style="color: #000000;"></span><span style="color: #0000FF;">&lt;</span><span style="color: #800000;">configuration</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;"> 3</span> <span style="color: #000000;">  <br /></span><span style="color: #008080;"> 4</span> <span style="color: #000000;">  </span><span style="color: #0000FF;">&lt;</span><span style="color: #800000;">system.serviceModel</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">    ...<br /></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">    </span><span style="color: #0000FF;">&lt;</span><span style="color: #800000;">behaviors</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;"> 7</span> <span style="color: #000000;">      </span><span style="color: #0000FF;">&lt;</span><span style="color: #800000;">serviceBehaviors</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">        </span><span style="color: #0000FF;">&lt;</span><span style="color: #800000;">behavior</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">          ...<br /></span><span style="color: #008080;">10</span> <span style="color: #000000;">          </span><span style="color: #0000FF;">&lt;</span><span style="color: #800000;">serviceAuthorization </span><span style="color: #FF0000;">serviceAuthorizationManagerType</span><span style="color: #0000FF;">=&quot;FullyQualifiedTypeName, AssemblyName&quot;</span><span style="color: #FF0000;"> </span><span style="color: #0000FF;">/&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">11</span> <span style="color: #000000;">          ...<br /></span><span style="color: #008080;">12</span> <span style="color: #000000;">        </span><span style="color: #0000FF;">&lt;/</span><span style="color: #800000;">behavior</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">13</span> <span style="color: #000000;">      </span><span style="color: #0000FF;">&lt;/</span><span style="color: #800000;">serviceBehaviors</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">14</span> <span style="color: #000000;">    </span><span style="color: #0000FF;">&lt;/</span><span style="color: #800000;">behaviors</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">15</span> <span style="color: #000000;">  </span><span style="color: #0000FF;">&lt;/</span><span style="color: #800000;">system.serviceModel</span><span style="color: #0000FF;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">16</span> <span style="color: #000000;"><br /></span><span style="color: #008080;">17</span> <span style="color: #000000;"><br /></span><span style="color: #008080;">18</span> <span style="color: #000000;"></span><span style="color: #0000FF;">&lt;/</span><span style="color: #800000;">configuration</span><span style="color: #0000FF;">&gt;</span></div></pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div><p>The client that invokes the web service must then be updated to create the Authorization header for every service operation. The following code example shows this.</p><div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:9c4cf2eb-8b4a-487a-9c25-ae47c40ca7a7" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"><pre style=" width: 808px; height: 293px;background-color:White;overflow: visible;"><div><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: #008080;"> 1</span> <span style="color: #0000FF;">using</span><span style="color: #000000;"> (var client </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000FF;">new</span><span style="color: #000000;"> Proxy.Client())<br /></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{<br /></span><span style="color: #008080;"> 3</span> <span style="color: #000000;">    var userName </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800000;">&quot;</span><span style="color: #800000;">&lt;username goes here&gt;</span><span style="color: #800000;">&quot;</span><span style="color: #000000;">;<br /></span><span style="color: #008080;"> 4</span> <span style="color: #000000;">    var password </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800000;">&quot;</span><span style="color: #800000;">&lt;password goes here&gt;</span><span style="color: #800000;">&quot;</span><span style="color: #000000;">;<br /></span><span style="color: #008080;"> 5</span> <span style="color: #000000;"><br /></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">    </span><span style="color: #008000;">//</span><span style="color: #008000;"> Create the authorization header</span><span style="color: #008000;"><br /></span><span style="color: #008080;"> 7</span> <span style="color: #008000;"></span><span style="color: #000000;">    var httpRequestProperty </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000FF;">new</span><span style="color: #000000;"> HttpRequestMessageProperty();<br /></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    httpRequestProperty.Headers[HttpRequestHeader.Authorization] </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800000;">&quot;</span><span style="color: #800000;">Basic </span><span style="color: #800000;">&quot;</span><span style="color: #000000;"> </span><span style="color: #000000;">+</span><span style="color: #000000;"><br /></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">        Convert.ToBase64String(Encoding.ASCII.GetBytes(userName </span><span style="color: #000000;">+</span><span style="color: #000000;"> </span><span style="color: #800000;">&quot;</span><span style="color: #800000;">:</span><span style="color: #800000;">&quot;</span><span style="color: #000000;"> </span><span style="color: #000000;">+</span><span style="color: #000000;"> password));<br /></span><span style="color: #008080;">10</span> <span style="color: #000000;"><br /></span><span style="color: #008080;">11</span> <span style="color: #000000;">    </span><span style="color: #0000FF;">using</span><span style="color: #000000;"> (</span><span style="color: #0000FF;">new</span><span style="color: #000000;"> OperationContextScope(client.InnerChannel))<br /></span><span style="color: #008080;">12</span> <span style="color: #000000;">    {<br /></span><span style="color: #008080;">13</span> <span style="color: #000000;">        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Add the authorization header to every outgoing message</span><span style="color: #008000;"><br /></span><span style="color: #008080;">14</span> <span style="color: #008000;"></span><span style="color: #000000;">        OperationContext.Current.OutgoingMessageProperties[HttpRequestMessageProperty.Name] </span><span style="color: #000000;">=</span><span style="color: #000000;"> httpRequestProperty;<br /></span><span style="color: #008080;">15</span> <span style="color: #000000;">        <br /></span><span style="color: #008080;">16</span> <span style="color: #000000;">        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Make web requests</span><span style="color: #008000;"><br /></span><span style="color: #008080;">17</span> <span style="color: #008000;"></span><span style="color: #000000;">    }<br /></span><span style="color: #008080;">18</span> <span style="color: #000000;">}     </span></div></pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div></p><br /><p>&nbsp;</p><p>The <a href="http://msdn.microsoft.com/en-us/library/system.servicemodel.channels.httprequestmessageproperty(v=vs.110).aspx">HttpRequestMessageProperty</a> class is used to provide access to the HTTP request, with the <a href="http://msdn.microsoft.com/en-us/library/system.servicemodel.channels.httprequestmessageproperty.headers(v=vs.110).aspx">Headers</a> property providing access to the HTTP headers from the request. It’s then easy to add an Authorization header that comprises “Basic “ and the base64 encoded “username:password” string. The <a href="http://msdn.microsoft.com/en-us/library/system.servicemodel.operationcontextscope(v=vs.110).aspx">OperationContextScope</a> class is then used to add the authorization header to every outgoing message.</p><h3>Summary</h3><p>This blog post has demonstrated how to use basic authentication in an Azure cloud service, without having to expose the underlying virtual machine that the service runs on, and without then having to undertake messy configuration of the virtual machine. It offers more flexibility than using ISS basic authentication, as you can specify the credentials in your service, instead of having to rely upon basic authentication against a Windows account.</p>  