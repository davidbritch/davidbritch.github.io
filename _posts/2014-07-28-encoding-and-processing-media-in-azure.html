---
layout: post
title: Encoding and processing media in Azure Media Services
date: '2014-07-28T09:32:00.001+01:00'
author: David Britch
tags:
- Azure Media Services
modified_time: '2014-07-28T09:33:40.573+01:00'
thumbnail: http://lh5.ggpht.com/-UJ7r_VRGjh0/U9YKrJ6CF8I/AAAAAAAACpc/iPG2FJbEh4I/s72-c/untitled15.jpg?imgmax=800
blogger_id: tag:blogger.com,1999:blog-8265682915956744370.post-151345465301191083
blogger_orig_url: https://dbritch.blogspot.com/2014/07/encoding-and-processing-media-in-azure.html
---

<p><a href="http://www.davidbritch.com/2014/06/uploading-content-into-azure-media.html">Previously</a> I’ve summarised the media upload process from client apps into a video on-demand service that uses Azure Media Services.</p> <p>In this blog post I’ll summarise how to incorporate Media Services’ encoding and processing functionality into an app. To do this you create processing jobs that enable you to schedule and automate the encoding and processing of assets.</p> <h3>Encoding and processing media</h3> <p>Media services provides a number of <em>media processors</em> that enable media to be processed. Media processors handle a specific processing task, such as encoding, format conversion, encrypting, or decrypting content. Encoding video is the most common Media Services processing operation, and is performed by the Azure Media Encoder. The Media Encoder is configured using encoder preset strings, with each preset specifying a group of settings required for the encoder. For a list of all the presets see <a href="http://msdn.microsoft.com/en-us/library/dn735913.aspx">Azure Media Encoder Presets</a>.</p> <p>Media Services supports progressive download of video and streaming. When encoding for progressive download you encode to a single bitrate. To be able to stream content it must first be converted into a streaming format. There are two types of streaming offered by Media Services:</p> <ul> <li>Single bitrate streaming  <li>Adaptive bitrate streaming</li></ul> <p>With single bitrate streaming a video is encoded to a single bitrate stream and divided into chunks. The stream is delivered to the client one chunk at a time. The chunk is displayed and the client then requests the next chunk. When encoding for adaptive bitrate streaming you encode to an MP4 bitrate set that creates a number of different bitrate streams. These streams are also broken into chunks. However, adaptive bitrate technologies allow the client to determine network conditions and select from among several bitrates. When network conditions degrade, the client can select a lower bitrate allowing the video to continue to play at a lower quality. Once network conditions improve the client can switch back to a higher bitrate with improved quality.</p> <p>Media Services supports three adaptive bitrate streaming technologies:</p> <ol> <li>Smooth streaming, created by Microsoft  <li>HTTP Live Streaming (HLS), created by Apple  <li>MPEG-DASH, an ISO standard</li></ol> <h5>Accessing media processors</h5> <p>Processing jobs involve calling a specific media process to process the job. Media Services supports the following media processors:</p> <table cellspacing="0" cellpadding="2" width="837" border="1"> <tbody> <tr> <td valign="top" width="199"><strong>Media processor</strong></td> <td valign="top" width="636"><strong>Description</strong></td></tr> <tr> <td valign="top" width="199">Azure Media Encoder</td> <td valign="top" width="636">Allows you to run encoding tasks using the Media Encoder,</td></tr> <tr> <td valign="top" width="199">Azure Media Packager</td> <td valign="top" width="636">Allows you to convert media assets from MP4 to Smooth Streaming format, and Smooth Streaming assets to HLS format..</td></tr> <tr> <td valign="top" width="199">Azure Media Encryptor</td> <td valign="top" width="636">Allows you to encrypt media assets using PlayReady protection.</td></tr> <tr> <td valign="top" width="199">Storage Decryption</td> <td valign="top" width="636">Allows you to decrypt media assets that were encrypted using storage encryption.</td></tr></tbody></table> <p>To use a specific media processor you should pass the name of the processor into the <strong>GetLatestMediaProcessorByName</strong> method.</p> <div id="codeSnippetWrapper" style="overflow: auto; cursor: text; font-size: 8pt; border-top: silver 1px solid; font-family: 'Courier New', courier, monospace; border-right: silver 1px solid; border-bottom: silver 1px solid; padding-bottom: 4px; direction: ltr; text-align: left; padding-top: 4px; padding-left: 4px; margin: 20px 0px 10px; border-left: silver 1px solid; line-height: 12pt; padding-right: 4px; max-height: 200px; width: 97.5%; background-color: #f4f4f4"> <div id="codeSnippet" style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4"><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: white"><span style="color: #0000ff">private</span> IMediaProcessor GetLatestMediaProcessorByName(<span style="color: #0000ff">string</span> mediaProcessorName)</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4">{</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: white">    var processor = <span style="color: #0000ff">this</span>.context.MediaProcessors.Where(p =&gt; p.Name == mediaProcessorName)</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4">        .ToList().OrderBy(p =&gt; <span style="color: #0000ff">new</span> Version(p.Version)).LastOrDefault();</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: white">&nbsp;</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4">    <span style="color: #0000ff">if</span> (processor == <span style="color: #0000ff">null</span>)</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: white">    {</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4">        <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> ArgumentException(<span style="color: #0000ff">string</span>.Format(<span style="color: #006080">"Unknown media processor: {0}"</span>, mediaProcessorName));</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: white">    }</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4">                </pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: white">    <span style="color: #0000ff">return</span> processor;</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4">}</pre><!--CRLF--></div></div><p>This method retrieves the specified media processor and returns an instance of it. It can be invoked as follows:</p><div id="codeSnippetWrapper" style="overflow: auto; cursor: text; font-size: 8pt; border-top: silver 1px solid; font-family: 'Courier New', courier, monospace; border-right: silver 1px solid; border-bottom: silver 1px solid; padding-bottom: 4px; direction: ltr; text-align: left; padding-top: 4px; padding-left: 4px; margin: 20px 0px 10px; border-left: silver 1px solid; line-height: 12pt; padding-right: 4px; max-height: 200px; width: 97.5%; background-color: #f4f4f4"><div id="codeSnippet" style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4"><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: white">IMediaProcessor mediaProcessor = <span style="color: #0000ff">this</span>.GetLatestMediaProcessorByName(MediaProcessorNames.WindowsAzureMediaEncoder);</pre><!--CRLF--></div></div><h5>Creating encoding jobs</h5><p>After media has been uploaded into Media Services it can be encoded into one of the formats supported by the Media Services Encoder. The Media Services Encoder supports encoding using the H.264 and VC-1 codecs, and can generate MP4 and Smooth Streaming content. However, MP4 and Smooth Streaming content can be converted to HLS v3 or MPEG-DASH by using <a href="http://msdn.microsoft.com/en-us/library/dn735905.aspx#DynamicPackaging">dynamic packaging</a>.</p><p>Encoding jobs are created and controlled using a <a href="http://msdn.microsoft.com/en-us/library/hh974289.aspx">Job</a>. Each <strong>Job</strong> contains metadata about the processing to be performed, and contains one or more <a href="http://msdn.microsoft.com/en-us/library/hh974286.aspx">Task</a>s that specify a processing task, its input <a href="http://msdn.microsoft.com/en-us/library/hh974277.aspx">Asset</a>s, output <strong>Asset</strong>s, and a media processor and its settings. <strong>Task</strong>s within a <strong>Job</strong> can be chained together, where the output asset of one task is given as the input asset to the next task. By following this approach one <strong>Job</strong> can contain all of the processing required for a media presentation.</p><p>The following diagram shows a high-level overview of the media encoding process used in the <a href="http://msdn.microsoft.com/en-us/library/dn735912.aspx">Building an On-Demand Video Service with Microsoft Azure Media Services</a> project.</p><p><img title="untitled1" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto" border="0" alt="untitled1" src="http://lh5.ggpht.com/-UJ7r_VRGjh0/U9YKrJ6CF8I/AAAAAAAACpc/iPG2FJbEh4I/untitled15.jpg?imgmax=800" width="552" height="471"></p><p>The <strong>EncodingService</strong> class retrieves the asset details from the CMS database and passes the encoding job to Media Services, where it’s submitted to the Azure Media Encoder. The encoding job and video details are saved to the CMS database while the Media Encoder processes the job, retrieving the input asset from Azure Storage, and writing the output assets to Azure Storage. When encoding is complete Media Services notifies the <strong>EncodingService</strong> class, which generate locator URLS to the output assets in Azure Storage, and updates the encoding job and video details in the CMS database. For a code walkthrough of this process see <a href="http://msdn.microsoft.com/en-us/library/dn735907.aspx#sec8">Encoding process in the Contoso Azure Media Services web service</a>.</p><p>By default, each Media Services account can have one active encoding task at a time. However, you can reserve encoding units that allow you to have multiple encoding tasks running concurrently. For more information see <a href="http://azure.microsoft.com/en-us/documentation/articles/media-services-how-to-scale/">How to Scale a Media Service</a>.</p><p><strong>Accessing encoded media</strong></p><p>Accessing content in Media Services requires a locator, which combines the URL to the media file with a set of time-based access permissions. There are two types of locators – shared access signature (SAS) locators and on-demand origin locators.</p><p>A SAS locator grants access rights to a specific media asset through a URL. By using the URL you are granting users who have the URL access to a specific resource for a period of time, in addition to specifying what operations can be performed on the resource.</p><p>On-demand origin locators are used when streaming content to a client app, and are exposed by the Media Services Origin Service which pulls the content from Azure Storage and delivers it to the client. An on-demand origin locator URL will point to a streaming manifest file in asset. For more information about the Origin Service see <a href="http://msdn.microsoft.com/en-us/library/dn735905.aspx#OriginService">Origin Service</a>.</p><h3>Summary</h3><p>This blog post has summarised how to use the Azure Media Encoder to encode uploaded media for delivery to client apps.To do this you create a media processing job that enables you to schedule and automate the encoding of assets. For more info see <a href="http://msdn.microsoft.com/en-us/library/dn735912.aspx">Building an On-Demand Video Service with Microsoft Azure Media Services</a>.</p><p>In my next blog post I’ll discuss the final step in the Media Services workflow – delivering and consuming media.</p>  