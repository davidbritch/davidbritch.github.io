---
layout: post
title: Encrypting and decrypting data in an Azure service using a certificate
date: '2014-12-22T08:42:00.000Z'
author: David Britch
tags:
- Azure
- C#
modified_time: '2014-12-22T08:46:18.968Z'
blogger_id: tag:blogger.com,1999:blog-8265682915956744370.post-3021513811268453538
blogger_orig_url: https://dbritch.blogspot.com/2014/12/encrypting-and-decrypting-data-in-azure.html
---

<p>I recently had a requirement to encrypt some data stored in a Web.config file for an Azure hosted service that’s accessed over HTTPS.</p> <p>To help secure information in configuration files, ASP.NET provides a feature called protected configuration, which enables the encryption of sensitive data in a configuration file. The <a href="http://msdn.microsoft.com/en-us/library/zhhddkxy(v=vs.140).aspx">recommended approach</a> is to protect configuration using either the <a href="http://msdn.microsoft.com/en-us/library/system.configuration.dpapiprotectedconfigurationprovider(v=vs.110).aspx">DpapiProtectedConfigurationProvider</a> class or the <a href="http://msdn.microsoft.com/en-us/library/system.configuration.rsaprotectedconfigurationprovider(v=vs.110).aspx">RsaProtectedConfigurationProvider</a> class that are both included in the .NET framework.</p> <p>Unfortunately these protected configuration providers do not work with Azure. The <a href="http://msdn.microsoft.com/en-us/library/system.configuration.dpapiprotectedconfigurationprovider(v=vs.110).aspx">DpapiProtectedConfigurationProvider</a> class uses a machine-specific key that cannot be transferred to Azure. While the <a href="http://msdn.microsoft.com/en-us/library/system.configuration.rsaprotectedconfigurationprovider(v=vs.110).aspx">RsaProtectedConfigurationProvider</a> enables transferring an RSA key pair in an XML file to different machines, and then importing the key to a key container, the XML file is meant to be removed from the machine after the key has been imported. On Azure, since the account running the Web role doesn’t have permissions to delete files in the web root, it is not possible to remove the XML file.</p> <p>I needed a solution that would:</p> <ol> <li>Allow data to be decrypted when running the service locally, and when running the service in Azure.  <li>Allow data to be encrypted and decrypted on any machine in our organization.  <li>Not be so onerous to prevent the periodic changing of the data to be encrypted/decrypted.</li></ol> <p>The <a href="https://code.msdn.microsoft.com/windowsazure/Encrypt-Configuration-5a8e8dfe">recommended approach</a> for Azure is to use the Pkcs12 custom protected configuration provider and the Aspnet_regiss.exe tool to encrypt sections of the configuration file. The Pkcs12 format enables transfer of certificates and their corresponding private keys from one machine to another. This provider is similar to the <a href="http://msdn.microsoft.com/en-us/library/system.configuration.rsaprotectedconfigurationprovider(v=vs.110).aspx">RsaProtectedConfigurationProvider</a>, with the difference being that instead of transferring the RSA key pair in an XML file, it relies on the transfer to occur using a certificate in .PFX format. This approach <a href="http://msdn.microsoft.com/en-us/library/hh680952(v=pandp.50).aspx">has been used</a> by P&amp;P in the <a href="http://msdn.microsoft.com/en-us/library/hh680892(v=pandp.50).aspx">Autoscaling Application Block</a>. While this provider works with the built-in tooling in ASP.NET that can read configuration automatically, it is an onerous solution for configuration that may change periodically.</p> <p>This blog post details my solution, which was to use the SSL cert for the service to encrypt data once on a local machine, and then use the SSL certificate to decrypt data both locally and in Azure. The advantage of this approach is that for a service delivered over HTTPS, Azure will already have the SSL certificate stored in its certificate store, and so no additional key transfer is required.</p> <h3>Implementation</h3> <p>To encrypt a piece of data you must first retrieve the SSL certificate from its location in the certificate store, and then encrypt the data using the certificate. The following code example shows this process.</p> <div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:4bbeddf5-f325-4211-ab13-de0da9c25938" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"><pre style=" width: 808px; height: 334px;background-color:White;overflow: visible;"><div><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: #008080;"> 1</span> <span style="color: #0000FF;">private</span><span style="color: #000000;"> </span><span style="color: #0000FF;">static</span><span style="color: #000000;"> </span><span style="color: #0000FF;">string</span><span style="color: #000000;"> Encrypt(</span><span style="color: #0000FF;">string</span><span style="color: #000000;"> plainText)<br /></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{<br /></span><span style="color: #008080;"> 3</span> <span style="color: #000000;">    </span><span style="color: #008000;">//</span><span style="color: #008000;"> Thumb value for SSL cert</span><span style="color: #008000;"><br /></span><span style="color: #008080;"> 4</span> <span style="color: #008000;"></span><span style="color: #000000;">    var thumb </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800000;">&quot;</span><span style="color: #800000;">&lt;thumbprint goes here&gt;</span><span style="color: #800000;">&quot;</span><span style="color: #000000;">;<br /></span><span style="color: #008080;"> 5</span> <span style="color: #000000;"><br /></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">    var passwordBytes </span><span style="color: #000000;">=</span><span style="color: #000000;"> UTF8Encoding.UTF8.GetBytes(plainText);<br /></span><span style="color: #008080;"> 7</span> <span style="color: #000000;">    var contentInfo </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000FF;">new</span><span style="color: #000000;"> ContentInfo(passwordBytes);<br /></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    var env </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000FF;">new</span><span style="color: #000000;"> EnvelopedCms(contentInfo);<br /></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">    X509Store store </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000FF;">null</span><span style="color: #000000;">;<br /></span><span style="color: #008080;">10</span> <span style="color: #000000;">    </span><span style="color: #0000FF;">string</span><span style="color: #000000;"> cipherText </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000FF;">null</span><span style="color: #000000;">;<br /></span><span style="color: #008080;">11</span> <span style="color: #000000;"><br /></span><span style="color: #008080;">12</span> <span style="color: #000000;">    </span><span style="color: #0000FF;">try</span><span style="color: #000000;"><br /></span><span style="color: #008080;">13</span> <span style="color: #000000;">    {<br /></span><span style="color: #008080;">14</span> <span style="color: #000000;">        store </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000FF;">new</span><span style="color: #000000;"> X509Store(StoreName.My, StoreLocation.LocalMachine);<br /></span><span style="color: #008080;">15</span> <span style="color: #000000;">        store.Open(OpenFlags.ReadOnly);<br /></span><span style="color: #008080;">16</span> <span style="color: #000000;">        var cert </span><span style="color: #000000;">=</span><span style="color: #000000;"> store.Certificates.Cast</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">X509Certificate2</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">().Where(xc </span><span style="color: #000000;">=&gt;</span><span style="color: #000000;"> xc.Thumbprint </span><span style="color: #000000;">==</span><span style="color: #000000;"> thumb).Single();<br /></span><span style="color: #008080;">17</span> <span style="color: #000000;">        env.Encrypt(</span><span style="color: #0000FF;">new</span><span style="color: #000000;"> CmsRecipient(cert));<br /></span><span style="color: #008080;">18</span> <span style="color: #000000;"><br /></span><span style="color: #008080;">19</span> <span style="color: #000000;">        cipherText </span><span style="color: #000000;">=</span><span style="color: #000000;"> Convert.ToBase64String(env.Encode());<br /></span><span style="color: #008080;">20</span> <span style="color: #000000;">    }<br /></span><span style="color: #008080;">21</span> <span style="color: #000000;">    </span><span style="color: #0000FF;">finally</span><span style="color: #000000;"><br /></span><span style="color: #008080;">22</span> <span style="color: #000000;">    {<br /></span><span style="color: #008080;">23</span> <span style="color: #000000;">        </span><span style="color: #0000FF;">if</span><span style="color: #000000;"> (store </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000FF;">null</span><span style="color: #000000;">)<br /></span><span style="color: #008080;">24</span> <span style="color: #000000;">            store.Close();<br /></span><span style="color: #008080;">25</span> <span style="color: #000000;">    }<br /></span><span style="color: #008080;">26</span> <span style="color: #000000;">    </span><span style="color: #0000FF;">return</span><span style="color: #000000;"> cipherText;<br /></span><span style="color: #008080;">27</span> <span style="color: #000000;">}</span></div></pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div><p>&nbsp;</p><br /><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>The <a href="http://msdn.microsoft.com/en-us/library/system.security.cryptography.x509certificates.x509store(v=vs.110).aspx">X509Store</a> class is used to provide access to the X.509 store, which is the physical store where certificates are persisted and managed. Once the store has been opened in read only mode, the SSL certificate is retrieved by searching for its <a href="http://msdn.microsoft.com/en-us/library/system.security.cryptography.x509certificates.x509certificate2.thumbprint(v=vs.110).aspx">thumbprint</a> value. The data to be encrypted is stored in a CMS/PKCS #7 enveloped data structure, and is encrypted using the <a href="http://msdn.microsoft.com/en-us/library/882kkwk6(v=vs.110).aspx">EnvelopedCms.Encrypt</a> method. It’s then base64 encoded before being returned from the method.</p><p>Decrypting the data simply reverses the process. The same SSL certificate is retrieved from the certificate store, and then is used to decrypt the data. The following code example shows this process.</p><div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:ced186f5-7588-4890-bdd0-a4f6a1210a12" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"><pre style=" width: 808px; height: 334px;background-color:White;overflow: visible;"><div><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: #008080;"> 1</span> <span style="color: #0000FF;">private</span><span style="color: #000000;"> </span><span style="color: #0000FF;">static</span><span style="color: #000000;"> </span><span style="color: #0000FF;">string</span><span style="color: #000000;"> Decrypt(</span><span style="color: #0000FF;">string</span><span style="color: #000000;"> cipherText)<br /></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{<br /></span><span style="color: #008080;"> 3</span> <span style="color: #000000;">    </span><span style="color: #008000;">//</span><span style="color: #008000;"> Thumb value for SSL cert</span><span style="color: #008000;"><br /></span><span style="color: #008080;"> 4</span> <span style="color: #008000;"></span><span style="color: #000000;">    var thumb </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800000;">&quot;</span><span style="color: #800000;">&lt;thumbprint goes here&gt;</span><span style="color: #800000;">&quot;</span><span style="color: #000000;">;<br /></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">    X509Store store </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000FF;">null</span><span style="color: #000000;">;<br /></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">    </span><span style="color: #0000FF;">string</span><span style="color: #000000;"> plainText </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000FF;">null</span><span style="color: #000000;">;<br /></span><span style="color: #008080;"> 7</span> <span style="color: #000000;"><br /></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    </span><span style="color: #0000FF;">try</span><span style="color: #000000;"><br /></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">    {<br /></span><span style="color: #008080;">10</span> <span style="color: #000000;">        store </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000FF;">new</span><span style="color: #000000;"> X509Store(StoreName.My, StoreLocation.LocalMachine);<br /></span><span style="color: #008080;">11</span> <span style="color: #000000;">        store.Open(OpenFlags.ReadOnly);<br /></span><span style="color: #008080;">12</span> <span style="color: #000000;">        var cert </span><span style="color: #000000;">=</span><span style="color: #000000;"> store.Certificates.Cast</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">X509Certificate2</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">().Where(xc </span><span style="color: #000000;">=&gt;</span><span style="color: #000000;"> xc.Thumbprint </span><span style="color: #000000;">==</span><span style="color: #000000;"> thumb).Single();<br /></span><span style="color: #008080;">13</span> <span style="color: #000000;">        var bytes </span><span style="color: #000000;">=</span><span style="color: #000000;"> Convert.FromBase64String(cipherText);<br /></span><span style="color: #008080;">14</span> <span style="color: #000000;">        var env </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000FF;">new</span><span style="color: #000000;"> EnvelopedCms();<br /></span><span style="color: #008080;">15</span> <span style="color: #000000;">        env.Decode(bytes);<br /></span><span style="color: #008080;">16</span> <span style="color: #000000;">        env.Decrypt();<br /></span><span style="color: #008080;">17</span> <span style="color: #000000;">        plainText </span><span style="color: #000000;">=</span><span style="color: #000000;"> Encoding.UTF8.GetString(env.ContentInfo.Content);<br /></span><span style="color: #008080;">18</span> <span style="color: #000000;">    }<br /></span><span style="color: #008080;">19</span> <span style="color: #000000;">    </span><span style="color: #0000FF;">finally</span><span style="color: #000000;"><br /></span><span style="color: #008080;">20</span> <span style="color: #000000;">    {<br /></span><span style="color: #008080;">21</span> <span style="color: #000000;">        </span><span style="color: #0000FF;">if</span><span style="color: #000000;"> (store </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000FF;">null</span><span style="color: #000000;">)<br /></span><span style="color: #008080;">22</span> <span style="color: #000000;">            store.Close();<br /></span><span style="color: #008080;">23</span> <span style="color: #000000;">    }<br /></span><span style="color: #008080;">24</span> <span style="color: #000000;">    </span><span style="color: #0000FF;">return</span><span style="color: #000000;"> plainText;<br /></span><span style="color: #008080;">25</span> <span style="color: #000000;">}</span></div></pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>The <a href="http://msdn.microsoft.com/en-us/library/system.security.cryptography.x509certificates.x509store(v=vs.110).aspx">X509Store</a> class is used to provide access to the X.509 store, with the constructor taking arguments that indicate which part of the certificate store should be opened. Once the store has been opened in read only mode, the SSL certificate is retrieved by searching for its <a href="http://msdn.microsoft.com/en-us/library/system.security.cryptography.x509certificates.x509certificate2.thumbprint(v=vs.110).aspx">thumbprint</a> value. The data to be decrypted is converted to a byte representation, from its base64 representation, before being decoded and decrypted by the <a href="http://msdn.microsoft.com/en-us/library/System.Security.Cryptography.Pkcs.EnvelopedCms(v=vs.110).aspx">EnvelopedCMS</a> class. The plain text is then returned from the method.</p><p>This approach to encryption and decryption enables you to store sensitive information in your configuration file in an encrypted form, which can then be decrypted both when running the service locally, and when running it in Azure. It offers the advantage that it’s not necessary to transfer additional keys to Azure in order to perform decryption, and it’s not too onerous a task to change encrypted data periodically.&nbsp; It can be further strengthened through the use of additional security techniques, including using the <a href="http://msdn.microsoft.com/en-us/library/system.security.securestring(v=vs.110).aspx">SecureString</a> class at appropriate places in the code.</p><h3>Summary</h3><p>This blog post has demonstrated how to encrypt and decrypt data using an SSL cert. My requirement was to encrypt/decrypt data stored in a configuration file, but it may equally be used with other data. The advantage of this approach is that it enables you to decrypt data both when running a service locally, and when running it in Azure, without the onerous task of copying additional encryption key data to Azure.</p>  