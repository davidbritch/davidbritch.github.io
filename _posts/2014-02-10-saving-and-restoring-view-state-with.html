---
title: Saving and restoring view state using Prism for the Windows Runtime
date: '2014-02-10T18:24:00.001Z'
author: David Britch
tags:
- MVVM
- C#
- Prism for the Windows Runtime
- Windows 8
- WinRT
- Windows Store app
modified_time: '2014-02-10T18:25:54.003Z'
blogger_id: tag:blogger.com,1999:blog-8265682915956744370.post-6818487284682624401
blogger_orig_url: https://dbritch.blogspot.com/2014/02/saving-and-restoring-view-state-with.html
---

<p><a href="http://www.davidbritch.com/2013/06/suspendresumeactivation-using-prism-for.html">Previously</a> I’ve written about how Prism for the Windows Runtime can be used to save and restore view model state.To have data survive the suspend/terminate cycle in a Prism app all you have to do is mark any view model properties whose data you want to survive termination with the custom <strong>[RestorableState]</strong> attribute. When the app is reactivated, any properties that are marked with this attribute will have their values restored. All of this work is performed by the <a href="http://www.nuget.org/packages/Prism.StoreApps/">Prism.StoreApps</a> library. For details of how Prism undertakes this operation see <a href="http://msdn.microsoft.com/en-us/library/windows/apps/xx130647.aspx">Handling suspend, resume, and activation in AdventureWorks Shopper</a>.</p> <p>Less well known is that Prism provides support for saving and restoring view state. Therefore, in this blog post I’ll extend the sample photo viewing app so that view state can be serialized during suspension, and de-serialized when the app reactivates. Specifically, the position of the <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.ui.xaml.controls.scrollviewer.aspx">ScrollViewer</a> thumb in the <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.ui.xaml.controls.gridview.aspx">GridView</a> on the <strong>MainPage</strong> will be serialized/de-serialized so that when the app reactivates following termination, the scroll position of the <strong>MainPage</strong> will be identical to when the app was suspended. Furthermore, the code will restore the correct scroll position even if the view state of the app changes in-between termination and reactivation.</p> <p>An obvious question is why would you want to save view state? Surely any controls in the view will just bind to properties in the view model? While that’s often the case, many controls contain other controls buried deeply within their control template. An example of this is the <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.ui.xaml.controls.gridview.aspx">GridView</a> control, which contains a <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.ui.xaml.controls.scrollviewer.aspx">ScrollViewer</a> control for scrolling purposes. Prism supports saving view state in order to easily support scenarios where you want to save the view state of a control that’s referenced through a control template.</p> <h3>Implementation</h3> <h5>Suspend</h5> <p>The <strong>SaveAsync</strong> method of the <strong>SessionStateService</strong> class is responsible for writing the current session state to disk, and is called by the <strong>OnSuspending</strong> event handler in the <strong>MvvmAppBase</strong> class.</p> <p>The <strong>SaveAsync</strong> method calls the <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.ui.xaml.controls.frame.getnavigationstate.aspx">GetNavigationState</a> method of each registered <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.ui.xaml.controls.frame.aspx">Frame</a> object in order to persist the serialized navigation history (the frame stack). In a Prism app there’s only one registered frame, and it corresponds to the <strong>rootFrame</strong> in the <strong>InitializeFrameAsync</strong> method in the <strong>MvvmAppBase</strong> class.</p> <p>When the <strong>SaveAsync</strong> method calls the <strong>GetNavigationState</strong> method, it in turn invokes the <strong>OnNavigatedFrom</strong> method of each of the frame’s associated page objects. The <strong>OnNavigatedFrom</strong> method in the <strong>VisualStateAwarePage</strong> class then invokes the <strong>SaveState</strong> method of any page that derives from it, allowing pages to save view state such as the current scroll position of a control.</p> <div id="codeSnippetWrapper" style="overflow: auto; cursor: text; font-size: 8pt; border-top: silver 1px solid; font-family: 'Courier New', courier, monospace; border-right: silver 1px solid; border-bottom: silver 1px solid; padding-bottom: 4px; direction: ltr; text-align: left; padding-top: 4px; padding-left: 4px; margin: 20px 0px 10px; border-left: silver 1px solid; line-height: 12pt; padding-right: 4px; max-height: 200px; width: 97.5%; background-color: #f4f4f4"><div id="codeSnippet" style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4"><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: white"><span style="color: #0000ff">protected</span> <span style="color: #0000ff">override</span> <span style="color: #0000ff">void</span> SaveState(Dictionary&lt;<span style="color: #0000ff">string</span>, <span style="color: #0000ff">object</span>&gt; pageState)</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4">{</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: white">    <span style="color: #0000ff">if</span> (pageState == <span style="color: #0000ff">null</span>) <span style="color: #0000ff">return</span>;</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4">&nbsp;</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: white">    <span style="color: #0000ff">base</span>.SaveState(pageState);</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4">&nbsp;</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: white">    pageState[<span style="color: #006080">"ScrollViewerOffsetProportion"</span>] = ScrollViewerUtilities.GetScrollViewerOffsetProportion(_photosGridViewScrollViewer);</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4">}</pre><!--CRLF--></div></div><p>The <strong>SaveState</strong> method preserves the state associated with the <strong>MainPage</strong>, in this case being a value that reflects the proportion of scrolling that has occurred either horizontally or vertically, depending on view state, within the <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.ui.xaml.controls.scrollviewer.aspx">ScrollViewer</a> of the <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.ui.xaml.controls.gridview.aspx">GridView</a>. This value is retrieved by the <strong>GetScrollViewerOffsetProportion</strong> method of the <strong>ScrollViewerUtilities</strong> class, and can be restored when reactivation occurs.</p><h5>Resume</h5><p>When an app resumes from suspension it continues from where it was when it was suspended, as the app is still stored in memory. Therefore, the sample app has no special behaviour associated with resuming from suspension.</p><h5>Activation</h5><p>Windows may terminate an app after it has been suspended, if the system is low on resources. When a Prism app is reactivated the <strong>OnLaunched</strong> method in the <strong>MvvmAppBase</strong> class calls the <strong>InitializeFrameAsync</strong> method, which in turn calls the <strong>RestoreFrameState</strong> method in the <strong>SessionStateService</strong> class.</p><p>The <strong>RestoreFrameState</strong> method calls the <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.ui.xaml.controls.frame.setnavigationstate.aspx">SetNavigationState</a> method of each registered <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.ui.xaml.controls.frame.aspx">Frame</a> object in order to restore the serialized navigation history (the frame stack). In the sample app there is only one registered frame, and it corresponds to the <strong>rootFrame</strong> in the <strong>InitializeFrameAsync</strong> method in the <strong>MvvmAppBase</strong> class.</p><p>When the <strong>RestoreFrameState</strong> method calls the <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.ui.xaml.controls.frame.setnavigationstate.aspx">SetNavigationState</a> method, it in turn invokes the <strong>OnNavigatedTo</strong> method of each of the frame’s associated page objects. The <strong>OnNavigatedTo</strong> method in the <strong>VisualStateAwarePage</strong> class then invokes the <strong>LoadState</strong> method of any page that derives from it, allowing pages to restore view state such as the current scroll position of a control.</p><div id="codeSnippetWrapper" style="overflow: auto; cursor: text; font-size: 8pt; border-top: silver 1px solid; font-family: 'Courier New', courier, monospace; border-right: silver 1px solid; border-bottom: silver 1px solid; padding-bottom: 4px; direction: ltr; text-align: left; padding-top: 4px; padding-left: 4px; margin: 20px 0px 10px; border-left: silver 1px solid; line-height: 12pt; padding-right: 4px; max-height: 200px; width: 97.5%; background-color: #f4f4f4"><div id="codeSnippet" style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4"><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: white"><span style="color: #0000ff">protected</span> <span style="color: #0000ff">override</span> <span style="color: #0000ff">void</span> LoadState(<span style="color: #0000ff">object</span> navigationParameter, Dictionary&lt;<span style="color: #0000ff">string</span>, <span style="color: #0000ff">object</span>&gt; pageState)</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4">{</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: white">    <span style="color: #0000ff">if</span> (pageState == <span style="color: #0000ff">null</span>) <span style="color: #0000ff">return</span>;</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4">&nbsp;</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: white">    <span style="color: #0000ff">base</span>.LoadState(navigationParameter, pageState);</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4">&nbsp;</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: white">    <span style="color: #0000ff">if</span> (pageState.ContainsKey(<span style="color: #006080">"ScrollViewerOffsetProportion"</span>))</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4">    {</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: white">        _scrollViewerOffsetProportion = <span style="color: #0000ff">double</span>.Parse(pageState[<span style="color: #006080">"ScrollViewerOffsetProportion"</span>].ToString(), CultureInfo.InvariantCulture.NumberFormat);</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4">    }</pre><!--CRLF--><pre style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: white">}</pre><!--CRLF--></div></div><p>The <strong>LoadState</strong> method restores state associated with the <strong>MainPage</strong>, in this case a value that reflects the proportion of horizontal or vertical scrolling that had occurred, depending on view state, within the <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.ui.xaml.controls.scrollviewer.aspx">ScrollViewer</a> of the <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.ui.xaml.controls.gridview.aspx">GridView</a>. The <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.ui.xaml.controls.scrollviewer.aspx">ScrollViewer</a> is set with the restored value by the <strong>ScrollToProportion</strong> method in the <strong>ScrollViewerUtilities</strong> class once the windows has rendered or changed its rendering size. Therefore, the user will see the page content scrolled to the exact location it was at prior to termination or navigation, regardless of whether the page orientation has changed in between termination and reactivation.</p><h3>Summary</h3><p>In this blog post I’ve further extended the sample photo viewer app so that along with view model state, view state can be serialized during suspension and de-serialized when the app reactivates following termination. This is achieved by overriding the <strong>SaveState</strong> and <strong>LoadState</strong> methods in a page that derives from the <strong>VisualStateAwarePage</strong> class, and then saving the desired state. In the sample app the user will see the page content scrolled to the exact location it was at prior to termination or navigation, regardless of whether the page orientation has changed in between termination and reactivation.</p><p>The sample app can be downloaded <a href="http://sdrv.ms/1h4xpVs">here</a>.</p>  