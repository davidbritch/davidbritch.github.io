---
title: Connecting to localhost over HTTPS for (Xamarin) Android release builds
date: '2020-08-14T15:49:00.003+01:00'
author: David Britch
tags:
- ".NET"
- C#
modified_time: '2020-08-14T16:06:28.040+01:00'
blogger_id: tag:blogger.com,1999:blog-8265682915956744370.post-8196950770575305273
blogger_orig_url: https://dbritch.blogspot.com/2020/08/connecting-to-localhost-over-https-for.html
---

<p>I've previously written several posts about connecting to localhost HTTPs services from Xamarin apps running on simulators and emulators. Over time this has become easier, and standardised, and my <a href="https://www.davidbritch.com/2020/04/connecting-to-locahost-over-https-from.html">last post</a> outlined the approach to take.</p><p>A user recently contacted me to point out that while my solution worked just fine in DEBUG mode, it didn't work in RELEASE mode on Android. This prompted much head scratching by me, and a journey into the heart of darkness, before I realised that I'm an idiot.</p><p>So the purpose of this blog post is to outline the solution to the issue, in the hope that others don't go down the rabbit hole I went down. It should also serve as a reminder to myself when I encounter this problem again in future.</p><h3 style="text-align: left;"><b>Problem</b></h3><p>There's a sample app that demos how to connect to localhost HTTPs services from iOS simulators and Android emulators. The idea is to ignore SSL errors on iOS/Android for local HTTPS services by setting the <b>HttpClientHandler.ServerCertificateCustomValidationCallback</b> property to a callback that ignores the result of the certificate security check for the localhost certificate. For more information about this, see <a href="https://www.davidbritch.com/2020/04/connecting-to-locahost-over-https-from.html">Connecting to localhost over HTTPS from simulators and emulators (revisited)</a>.</p><p>The problem was that while the solution outlined in my previous blog post worked fine in both DEBUG and RELEASE mode in iOS, it only worked in DEBUG mode on Android. When switched to a RELEASE build, the sample app wouldn't retrieve any data from the web service, but provided no indication why not. It was frustrating! Note that both DEBUG and RELEASE modes on Android were set to use the <b>AndroidClientHandler</b> native network stack.</p><h3 style="text-align: left;">Journey</h3><p>I convinced myself that the linker was linking out a type/namespace that was required. So I tried the usual trick of ensuring the type was referenced from C# in the Android project. That didn't help. Then I created a custom linker configuration (linker.xml) that specified key types and namespace to preserve. That also didn't help. I even tried turning the linker off. But still the app wouldn't retrieve any data from the localhost HTTPS web service.</p><p>I then had a diversion into wondering if it was related to the API level, so tried the app on different API levels. Still nothing.</p><p>Googling the issue didn't turn up anything similar. That was bizarre. No one had experienced anything remotely similar??? That made me wonder if it was a new issue, caused by the latest release of Mono. So I started looking at issues in the Mono.Android repo and while I found a few issues that initially looked promising, they were all dead ends.</p><p>So then I started to look at the code for the <b>AndroidClientHandler</b>&nbsp;class (in the Mono.Android repo), in the hope of finding an obvious property that needed setting, or method that needed calling. That didn't help either. I was just about to close my browser window when I noticed that <b>AndroidClientHandler</b>&nbsp;catches a number of Java exceptions. That got me thinking that maybe there's a native Java exception bubbling up, that <b>AndroidClientHandler</b>&nbsp;doesn't catch. So I added code to catch all Java exceptions to my Android project. That immediately revealed that a <b>Java.Net.SocketException</b>&nbsp;was occurring in <b>Xamarin.Android.Net.AndroidClientHandler.DoProcessRequest</b>&nbsp;(and wasn't being caught by <b>AndroidClientHandler</b>). The exception said that the socket failed due to an EACCES (permission denied) error.</p><p>It couldn't really be that simple could it??? It was.</p><h3 style="text-align: left;">Solution</h3><p>Ensure the Android manifest has the internet permission enabled. That should have been the first check I made. Yes, it really was just that.</p><p>Note to future Dave: check the Android manifest first next time!</p>