---
title: Playing audio with .NET MAUI
date: '2022-09-23T15:08:00.063+01:00'
author: David Britch
tags:
- ".NET MAUI"
- C#
modified_time: '2022-09-23T15:50:07.095+01:00'
thumbnail: https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjhvauXdscN10e6FOrI58z4sKSNoFUalLOeDB1hDBcfKsAiKvT_-xkLd5wyV2L-GhjUaCFlDpY-_TJVp9z6ucHOjuC87nOusKs62o7dxEcARM6uOVjJBisAzjjYMuTdJa26yUnxE6jxQpB4oE_K5HldIXZpJ3d9Z6nedGBQ0sQGluFeQ24HhmFn6c92/s72-c/audio-handler.png
blogger_id: tag:blogger.com,1999:blog-8265682915956744370.post-7030687416553686750
blogger_orig_url: https://dbritch.blogspot.com/2022/09/playing-audio-with-net-maui.html
---

<p>Many apps, whether mobile or desktop, require the ability to play audio. That audio may be remote, stored in the app bundle, or be chosen from the user’s device. However, .NET MAUI currently doesn’t have a cross-platform control capable of playing audio. However, all of the underlying platforms that .NET MAUI supports have native controls for playing audio. Android has <code>MediaPlayer</code>, iOS/Mac Catalyst has <code>AVPlayer</code>, and WinUI has <code>MediaPlayerElement</code> (only available in WinAppSDK 1.2-preview).</p>
<p>I’ve used these native types to create a cross-platform <code>Audio</code> control. It’s based on the <code>Video</code> control I created a month or two ago (see <a href="https://www.davidbritch.com/2022/07/playing-video-with-net-maui_28.html">Playing video with .NET MAUI</a> and <a href="https://www.davidbritch.com/2022/09/playing-video-with-net-maui-on-windows.html">Playing video with .NET MAUI on Windows</a>). It plays audio from URLs, from audio embedded in your app package (and hence embedded in your single project), and files chosen by the user on your device. As well as using the in-built transport controls to control audio playback, you can provide your own transport controls.</p>
<p>Are there code sharing opportunities between my <code>Audio</code> and <code>Video</code> controls? Yes. The code to play audio on iOS/Mac/Windows is 99% identical to the code to play video on iOS/Mac/Windows. Similarly, the cross-platform <code>Audio</code> control is a renamed version of the cross-platform <code>Video</code> control. The big difference is audio and video playback on Android. The <code>Video</code> control uses an Android <code>VideoView</code>, combined with a <code>MediaController</code>, while the <code>Audio</code> control uses an Android <code>MediaPlayer</code>, combined with a <code>MediaController</code>. It’ll be possible to merge the two controls into a single <code>Media</code> cross-platform control, capable of playing video and audio. Will I be doing this? Maybe at some point. Just not now.</p>
<p>You can download the control from its <a href="https://github.com/davidbritch/dotnet-maui-audioplayer">GitHub repo</a>.</p>
<p>An alternative approach to playing audio in a .NET MAUI app is to use <a href="https://github.com/jfversluis/Plugin.Maui.Audio">Plugin.Maui.Audio</a>, created by <a href="https://jfversluis.dev">Gerald Versluis</a> and <a href="https://blog.bijington.com">Shaun Lawrence</a>. Are there any code similarities between Plugin.Maui.Audio and what I’ve done? Not really. Plugin.Maui.Audio uses different types to play audio on iOS/Mac/Windows than I’ve used, requires you to provide your own transport controls, and doesn’t use handlers.</p>
<h2 id="handler-architecture">Handler architecture</h2>
<p>.NET MAUI has an extension mechanism, known as  <em>handlers</em>, that you can use to customise existing .NET MAUI controls, and write your own cross-platform views (controls) whose implementations are provided by native views (controls).</p>
<p>Each .NET MAUI cross-platform control is known as a <em>virtual view</em>.  <em>Handlers</em>  map these virtual views to native views on each platform, and are responsible for creating the underlying native view, and mapping their API to the cross-platform control. Each handler typically provides a  <em>property mapper</em>, and potentially a  <em>command mapper</em>, that maps the cross-platform view API to the native view API.</p>
<p>The following diagram shows the handler architecture for the <code>Audio</code> view:</p>
<img alt="" border="0" data-original-height="409" data-original-width="1000" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjhvauXdscN10e6FOrI58z4sKSNoFUalLOeDB1hDBcfKsAiKvT_-xkLd5wyV2L-GhjUaCFlDpY-_TJVp9z6ucHOjuC87nOusKs62o7dxEcARM6uOVjJBisAzjjYMuTdJa26yUnxE6jxQpB4oE_K5HldIXZpJ3d9Z6nedGBQ0sQGluFeQ24HhmFn6c92/s1600/audio-handler.png"/>
<p>The <code>Audio</code> type represents the cross-platform control. On iOS/Mac Catalyst the <code>AudioHandler</code> maps the <code>Audio</code> view to an iOS/Mac Catalyst <code>AVPlayer</code>. On Android, the <code>Audio</code> view is mapped to a <code>MediaPlayer</code>, and on WinUI the <code>Audio</code> view is mapped to a <code>MediaPlayerElement</code>.</p>
<p>The <code>PropertyMapper</code> in the <code>AudioHandler</code> class maps the cross-platform view properties to native view APIs via <em>mapper</em> methods. Each platform then provides implementations of the mapper methods, which manipulate the native view API as appropriate. The overall effect is that when a property is set on the cross-platform view, the underlying native view is updated as required.</p>
<p>The <code>CommandMapper</code> in the <code>AudioHandler</code> class maps cross-platform view commands to native view APIs via <em>mapper</em> methods. Command mappers provide a way for cross-platform controls to send commands to native views on each platform. They’re similar to property mappers, but allow for additional data to be passed. Note that commands, in this context, doesn’t mean <code>ICommand</code> implementations. In this context, a command is just a way of invoking some functionality on a native control. For example, the <code>ScrollView</code> in .NET MAUI uses a command mapper so that the <code>ScrollView</code> asks its handler to instruct the native views to scroll to a specific location, passing along the scroll arguments (such as the position or element it wants to scroll to). The <code>ScrollView</code> handler on each platform unpacks the scroll arguments and invokes native view functionality to perform the desired scroll. This was analogous in Xamarin.Forms to having an event on the cross-platform view, with the renderer subscribing to the event. The advantage of the command mapper approach is that it decouples the native view from the cross-platform view, and avoids the need to unsubscribe from events. It also allows for easy customisation - the command mapper can be modified by consumers without subclassing.</p>
<p>Handler implementations on each platform must override the <code>CreatePlatformView</code> method, and optionally the <code>ConnectHandler</code> and <code>DisconnectHandler</code> methods. The <code>CreatePlatformView</code> method should return the native view that implements the cross-platform view. The <code>ConnectHandler</code> method should perform any required native view setup, and the <code>DisconnectHandler</code> method should perform any required native view cleanup. Note that the <code>DisconnectHandler</code> override is intentionally not invoked by .NET MAUI - you have to invoke it yourself from a suitable place in your app’s lifecycle.</p>
<h2 id="code">Code</h2>
<p>I’m not going to provide a walkthrough of the code. But you can download it, and step through it yourself, by cloning the <a href="https://github.com/davidbritch/dotnet-maui-audioplayer">repo</a>. However, I’ll give you some pointers to working through the code.</p>
<p>The solution is structured as follows:</p>
<img alt="" border="0" data-original-height="255" data-original-width="199" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEikWuWCKE6vu4I57WKALF-c6GKOnC4SHdwOqLw15JSwuyAeWs8gOevok8mlK48whJclnd4B2EDtdjMW2EHSFHC2V01y7Foq70GlPx0FSIs2qni0QeYIVDOhcaiHriXXLn15_1juN7qFeEKP-HCwFkO4wK86JcZ_DnLrZOK975w2iUoe6bnqFBz8n6at/s1600/solution.png"/>
<p>The important folders in the solution are:</p>
<ul><li><p>Controls - the cross-platform view implementation.</p>
<img alt="" border="0" data-original-height="248" data-original-width="212" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEifMn43pMzEOL092eLyuwXVbEqZMVF7h9GcOK6_GnDy_5rpQ78g5AlTDZ2w_r54SPRayiVpRTbpJa-e55iNHuv9embVuBEikzVgTIkGBepAENN7_hQ9kMemTowiXHoLWV9ga98_KFl7GYQa4a4D8SM_YXOdZOKulaMbeIs7n6OMl26xahUR1ifikx0E/s1600/controls.png"/>
<p>The <code>Audio</code> class derives from .NET MAUI’s <code>View</code> class, provides the cross-platform implementation, and is a collection of <code>BindableProperty</code> objects and public methods.</p>
</li>
<li>
<p>Handlers - the handler implementation.</p>
<img alt="" border="0" data-original-height="107" data-original-width="198" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhOfXeFO74ceJxeuVyejWy4zugthwAGZ-g4OcL9yBNZWTewU_lftMwm63FEIfgWg5TFPiQXYFz9GZZb-V1VhpPL4xVMwDkXhgri4gJX9XXT7FXM9q1Mf6njUxZHJ8aySXs2zk5Q6ni1hrh-HwAguFFdYhHv7YwQ0TWPxeJRcB5IRSqRC9359yNLKalG/s1600/handlers.png"/>
<p>The <code>AudioHandler</code> class is a partial class, whose platform-specific implementations are in the <em>AudioHandler.Android.cs</em>, <em>AudioHandler.MaciOS.cs</em> and <em>AudioHandler.Windows.cs</em> files. The <code>AudioHandler</code> class exposes a <code>VirtualView</code> property that can be used to access the cross-platform view from the handler/native view layer. It also exposes a <code>PlatformView</code> property that can be used to access the native view that implements the <code>Audio</code> view.</p>
</li>
<li>
<p>Platforms - the native view implementations.</p>
<img alt="" border="0" data-original-height="504" data-original-width="200" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh2e9Gk7SoYiMrJBmopc3j-COKtXi8G4Xf1g67Ld-eZkwkItad9oKMZwnlWWtlO-MSu2XscGbJCCmEanOoo088TiRf9p8sXgC-uNbXy8AHs07a5d1lKhcAda57Pm-et9s1UpmXln3GICIZUgfOAMchBZxmrRjw-Zjzk0Ge-bSwwoTezq_KiyaOIHxcM/s1600/platforms.png"/>
<p>Rather than implement the native views directly in the handler, I’ve split them out into native view implementations named <code>MauiAudioPlayer</code>. On Android, <code>MauiAudioPlayer</code> derives from <code>CoordinatorLayout</code> and uses a <code>MediaPlayer</code> (along with a <code>MediaController</code>). On Android there’s also an <code>AudioProvider</code> class, which is a content provider that retrieves the embedded audio files from the assets folder of its bundle. On iOS/Mac Catalyst, <code>MauiAudioPlayer</code> derives from <code>UIView</code> and uses an <code>AVPlayer</code> (along with an <code>AVPlayerViewController</code> for the transport controls). On Windows, <code>MauiAudioPlayer</code> derives from <code>Grid</code> and uses a <code>MediaPlayerElement</code>.</p>
</li>
<li>
<p>Resources/Raw - three embedded audio files.</p>
<img alt="" border="0" data-original-height="231" data-original-width="187" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjxWP1UiF1BIXHKPB-o1I7XDmOYJbOA0YdnkKH_rSEp9p4JqqU3LoqmcyAr-2b7PZ1DgtTmf47ZQU6In_icnkcWWIgicYHPtqlsgkDP5KhpE9lQSEiXaRH9RAXmjCFg520iOIKy0hilhDgcTgeEcigUAVVI0iL603ALhAwPh1cAIhmcwrRcuOy_K5pK/s1600/resources.png"/>
<p>The audio files have a build action of <em>MauiAsset</em>.</p>
</li>
<li>
<p>Views - pages that exercise the <code>Audio</code> view. An event handler for the <code>Unloaded</code> event on each page invokes the <code>DisconnectHandler</code> override on <code>AudioHandler</code>.</p>
</li>
</ul>
<p>A handler must be registered against its cross-platform view, and this takes place in <em>MauiProgram.cs</em> with the <code>ConfigureMauiHandler/AddHandler</code> methods.</p>
<p>On iOS, I modified the <code>ContentOverlayView</code> of the <code>AVPlayerViewController</code> object to display an image (the idea being you could display something that represents the audio being played - any <code>UIView</code>-derived object):</p>
<pre class=" language-csharp"><code class="prism  language-csharp">UIImageView imageView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UIImageView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
imageView<span class="token punctuation">.</span>Image <span class="token operator">=</span> UIImage<span class="token punctuation">.</span><span class="token function">FromBundle</span><span class="token punctuation">(</span><span class="token string">"dotnet_bot.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
imageView<span class="token punctuation">.</span>ContentMode <span class="token operator">=</span> UIViewContentMode<span class="token punctuation">.</span>ScaleAspectFit<span class="token punctuation">;</span>
_playerViewController<span class="token punctuation">.</span>ContentOverlayView<span class="token punctuation">.</span><span class="token function">AddSubview</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span>

imageView<span class="token punctuation">.</span>TranslatesAutoresizingMaskIntoConstraints <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
imageView<span class="token punctuation">.</span>BottomAnchor<span class="token punctuation">.</span><span class="token function">ConstraintEqualTo</span><span class="token punctuation">(</span>_playerViewController<span class="token punctuation">.</span>ContentOverlayView<span class="token punctuation">.</span>BottomAnchor<span class="token punctuation">)</span><span class="token punctuation">.</span>Active <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
imageView<span class="token punctuation">.</span>TopAnchor<span class="token punctuation">.</span><span class="token function">ConstraintEqualTo</span><span class="token punctuation">(</span>_playerViewController<span class="token punctuation">.</span>ContentOverlayView<span class="token punctuation">.</span>TopAnchor<span class="token punctuation">)</span><span class="token punctuation">.</span>Active <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
imageView<span class="token punctuation">.</span>LeadingAnchor<span class="token punctuation">.</span><span class="token function">ConstraintEqualTo</span><span class="token punctuation">(</span>_playerViewController<span class="token punctuation">.</span>ContentOverlayView<span class="token punctuation">.</span>LeadingAnchor<span class="token punctuation">)</span><span class="token punctuation">.</span>Active <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
imageView<span class="token punctuation">.</span>TrailingAnchor<span class="token punctuation">.</span><span class="token function">ConstraintEqualTo</span><span class="token punctuation">(</span>_playerViewController<span class="token punctuation">.</span>ContentOverlayView<span class="token punctuation">.</span>TrailingAnchor<span class="token punctuation">)</span><span class="token punctuation">.</span>Active <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
</code></pre>
<p>This code retrieves the dotnet_bot image that’s stored in the <em>Resources\Raw</em> folder of the project, from the app bundle (where it’s copied to at build time), and centers it in the <code>ContentOverLay</code> view of the <code>AVPlayerViewController</code> object using constraints. This makes the audio player look less plain:</p>
<img alt="" border="0" height="600" data-original-height="911" data-original-width="484" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiFn4__6nMT9b1H8jxB2ITPdMLBx69RwPAq0Q-In0p4s1gX30fwKSahkqXjeoVZfsGfjPkQMa9S8YcH8xiYS6naUbvHwE86CFIhegTguUoTf709o_9mv3fcpXXpiO6UqOhczPka7Tt_3qir98vCOKi4brVcEOTL1KkVtLKmmTDZFHCwRwAeh6sX2njv/s600/Screenshot%202022-09-23%20at%2014.28.06.png"/>
<h2 id="next-steps">Next steps</h2>
<p>There are a couple of issues I’m aware of in the implementation. Firstly, the <code>FilePicker</code>, for selecting an audio file from the device, only works on Windows. On iOS/Android it lets you browse the device, but won’t let you select a file. On Mac Catalyst, it does nothing. At the moment I’ve yet to investigate whether these are MAUI bugs, or whether I’m doing something wrong/lacking a piece of config. Secondly, I’ve encountered a random crash on Android - I’m still trying to produce a firm repro case for it.</p>
<p>In addition, on Windows, the <code>MediaPlayerElement</code> seems to be reserving rendering space for a non-existent video. I need to look into whether there’s something I can do about that, or whether it’s due to <code>MediaPlayerElement</code> still being in preview.</p>

