---
layout: post
title: Playing video with .NET MAUI
date: '2022-07-28T13:17:00.130+01:00'
author: David Britch
tags:
- ".NET MAUI"
- C#
modified_time: '2022-07-29T10:42:36.469+01:00'
thumbnail: https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg05ba1tG5-wTE0CWEzCOqE5UJpoNaB-eXJRXiHoyCGA3OiPGZpS8UE2AishV982x2vzjkszn5H6dPgS_u8C1iv0m6iCEAO3qyLZl9Rakq6OV9Mqf-IrEiVpN8linzgMCeJ5ltd2JGHF2rAzNvD7iIzwU7Fm81AO17HvsNWDelq8MlC2bHypcH3pqNW/s72-c/video-handler.png
blogger_id: tag:blogger.com,1999:blog-8265682915956744370.post-6044716493276234337
blogger_orig_url: https://dbritch.blogspot.com/2022/07/playing-video-with-net-maui_28.html
---

<p>Many apps, whether mobile or desktop, require the ability to play video. That video may be remote, stored in the app bundle, or be chosen from the user’s device. However, .NET MAUI currently doesn’t have a view (control) capable of playing video. That’s frustrating because the underlying platforms that .NET MAUI supports all largely have native views for playing video. Android has the <code>VideoView</code>. iOS/MacCatalyst has <code>AVPlayer</code>. WinUI has…nothing yet, but I understand it’s coming soon.</p>
<p>So, most of the platforms .NET MAUI runs on can play video, but .NET MAUI itself lacks a cross-platform view to play video. Therefore I’ve created a cross-platform <code>Video</code> view. It changed name as I iterated over it. It started out as <code>VideoPlayer</code>, changed to <code>VideoView</code>, then I settled on <code>Video</code>, purely because .NET MAUI’s image view is called <code>Image</code>. Obviously the <code>Video</code> view plays video. Specifically, it plays video from URLs, from videos embedded in your app package (and hence embedded in your single project), and files chosen by the user on your device. As well as using the in-built transport controls to control video playback, you can provide your own transport controls. Does it play audio? Potentially but I’ve not tried it. It will most likely require some work to turn it into a <code>Media</code> view.</p>
<h2 id="handler-architecture">Handler architecture</h2>
<p>.NET MAUI has an extension mechanism, known as <em>handlers</em>, that you can use to customise existing .NET MAUI controls, and write your own cross-platform views whose implementations are provided by native views.</p>
<p>Each .NET MAUI view has an interface representation, that abstracts a cross-platform view. Cross-platform views that implement these interfaces are known as <em>virtual views</em>. <em>Handlers</em> map these virtual views to native views on each platform, and are responsible for creating the underlying native view, and mapping their API to the cross-platform control.</p>
<p>Handlers are accessed through their view-specific interface. This avoids the cross-platform view having to reference its handler, and the handler having to reference the cross-platform view. Each handler typically provides a <em>property mapper</em>, and potentially a <em>command mapper</em>, that maps the cross-platform view API to the native view API.</p>
<p>The following diagram shows the handler architecture for the <code>Video</code> view:</p>
<div class="separator" style="clear: both;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg05ba1tG5-wTE0CWEzCOqE5UJpoNaB-eXJRXiHoyCGA3OiPGZpS8UE2AishV982x2vzjkszn5H6dPgS_u8C1iv0m6iCEAO3qyLZl9Rakq6OV9Mqf-IrEiVpN8linzgMCeJ5ltd2JGHF2rAzNvD7iIzwU7Fm81AO17HvsNWDelq8MlC2bHypcH3pqNW/s1060/video-handler.png" style="display: block; padding: 1em 0; text-align: center; "><img alt="" border="0" width="600" data-original-height="798" data-original-width="1060" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg05ba1tG5-wTE0CWEzCOqE5UJpoNaB-eXJRXiHoyCGA3OiPGZpS8UE2AishV982x2vzjkszn5H6dPgS_u8C1iv0m6iCEAO3qyLZl9Rakq6OV9Mqf-IrEiVpN8linzgMCeJ5ltd2JGHF2rAzNvD7iIzwU7Fm81AO17HvsNWDelq8MlC2bHypcH3pqNW/s600/video-handler.png"/></a></div>
<p>The <code>Video</code> view implements the <code>IVideo</code> interface. On iOS/MacCatalyst, the <code>VideoHandler</code> class maps the cross-platform <code>Video</code> view to an iOS/MacCatalyst <code>AVPlayer</code>. On Android, the <code>Video</code> view is mapped to a <code>VideoView</code>. There’s currently no WinUI implementation (due to the lack of a <code>MediaElement</code> control on WinUI) but I’ll add one once WinUI supports playing video.</p>
<p>The <code>PropertyMapper</code> in the <code>VideoHandler</code> class maps the cross-platform view properties to native view APIs via <em>mapper</em> methods. Each platform then provides implementations of the mapper methods, which manipulate the native view API as appropriate. The overall effect is that when a property is set on the cross-platform view, the underlying native view is updated as required.</p>
<p>The <code>CommandMapper</code> in the <code>VideoHandler</code> class maps cross-platform view commands to native view APIs via <em>mapper</em> methods. Command mappers provide a way for cross-platform controls to send commands to native views on each platform. They’re similar to property mappers, but allow for additional data to be passed. Note that commands, in this context, doesn’t mean <code>ICommand</code> implementations. In this context, a command is just a way of invoking some functionality on a native control. For example, the <code>ScrollView</code> in .NET MAUI uses a command mapper so that the <code>ScrollView</code> asks its handler to instruct the native views to scroll to a specific location, passing along the scroll arguments (such as the position or element it wants to scroll to). The <code>ScrollView</code> handler on each platform unpacks the scroll arguments and invokes native view functionality to perform the desired scroll. This was analogous in Xamarin.Forms to having an event on the cross-platform view, with the renderer subscribing to the event. The advantage of the command mapper approach is that it decouples the native view from the cross-platform view, and avoids the need to unsubscribe from events. It also allows for easy customisation - the command mapper can be modified by consumers without subclassing.</p>
<p>Handler implementations on each platform must override the <code>CreatePlatformView</code> method, and optionally the <code>ConnectHandler</code> and <code>DisconnectHandler</code> methods. The <code>CreatePlatformView</code> method should return the native view that implements the cross-platform view. The <code>ConnectHandler</code> method should perform any required native view setup, and the <code>DisconnectHandler</code> method should perform any required native view cleanup. Note that the <code>DisconnectHandler</code> override is intentionally not invoked by .NET MAUI - you have to invoke it yourself from a suitable place in your app's lifecycle.</p>
<h2 id="code">Code</h2>
<p>I’m not going to provide a walkthrough of the code. But you can download it, and step through it yourself, by cloning the <a href="https://github.com/davidbritch/dotnet-maui-videoplayer">repo</a>. However, I will give you some pointers to working through the code.</p>
<p>The solution is structured as follows:</p>
<img alt="" border="0" height="320" data-original-height="275" data-original-width="204" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEivdjFb6_630xebsngwO8LO8irSz16UMp_B1IbKeZgM8DxueJ1og-9jhMv0m8t21odTrLynbyxs9jAch4NkPuhSXy_TC2AxUW_Vwky6bGXdw2uOV1GPejjnaprnJKHI3LC7BWKC1oXRFq62FaxEF7ZYDq76Bpgb11WHRsv24nTjxtF9MbxZ4_bjr1sP/s320/Capture6.PNG"/>
<p>The important folders in the solution are:</p>
<ul>
<li>
<p>Controls - the cross-platform view implementation.</p>
<img alt="" border="0" height="320" data-original-height="313" data-original-width="285" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhQ40o_Kbl9kSkQrHDgHyPS08a5aSUy9jK-vJr3M6Hk6lIGrC11XlypYXsTaRNn_olCLFyPKFDhWrqdd7CGOKHmUIv51P8DzTQykCPKUMspmxuJE58Q1RuC6Ek_dqIQPg5CVcV8v_cfXbu_tKMtDeU6-2h6UMQEmCe9cs0AuY9Y7lpbiu_yd4VKKTIA/s320/Capture1.PNG"/>
<p><code>IVideo</code> abstracts the <code>Video</code> view and exposes members that the <em>handler</em> needs to be able to access, and derives from .NET MAUI’s <code>IView</code>. The <code>Video</code> class, which derives from .NET MAUI’s <code>View</code> class, provides the cross-platform implementation, and is a collection of <code>BindableProperty</code> objects, events, and public methods.</p>
</li>
<li>
<p>Handlers - the handler implementation.</p>
<img alt="" border="0" width="320" data-original-height="143" data-original-width="275" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg4dnYgrckZTOkDRkRpDZxEoy8RFYfgxBBna0yuTQVnhpKeLLvRy21EibmVpWpozVsh5W7RlZwyj8vB1zGY58DQPdthuoxadFHuXArelPpkafECfOUvCC3UK5E-1_0g_EqSSFiTt3E6q0ul6UZZHBi9s_MnjX8VFwBzSN3euk70vWvHsu2S8gviDrVi/s320/Capture2.PNG"/>
<p>The <code>IVideoHandler</code> interface, which derives from .NET MAUI’s <code>IViewHandler</code>, specifies <code>VirtualView</code> and <code>PlatformView</code> properties. The <code>VirtualView</code> property is used to access the cross-platform view from the handler/native view layer, and the <code>PlatformView</code> property is used to access the native view that implements the <code>Video</code> view. The <code>VideoHandler</code> class is a partial class, whose platform-specific implementations are in the <em>VideoHandler.Android.cs</em>, <em>VideoHandler.iOS.cs</em> and <em>VideoHandler.Windows.cs</em> files.</p>
</li>
<li>
<p>Platforms - the native view implementations.</p>
<img alt="" border="0" height="400" data-original-height="477" data-original-width="257" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh5qX1XUeeJnylVhCnAjjZBmeDujASv9zbrg14DKkHexv0JYpyMf4d3JAd1_36pj4UEpa-xtauHxP7N6JpsNDcUYg5FCFaMbvUagN6sg-0g53ZluaUDt7w2g2rFdZcnOfvtqBpO9EbJs0BcryUwpw6UasFCFxm8sKney7UGk4Ehi6nCUPzEQdjoKz8Q/s400/Capture5.PNG"/>
<p>Rather than implement the native views directly in the handler, I’ve split them out into native view implementations called <code>MauiVideoPlayer</code>. On Android, <code>MauiVideoPlayer</code> derives from <code>RelativeLayout</code> (for positioning the video on the page) and uses a <code>VideoView</code> to play videos (along with a <code>MediaController</code> for the transport controls). On Android there’s also a <code>VideoProvider</code> class, which is a content provider that retrieves the embedded video files from the <em>assets</em> folder of its bundle. On iOS/MacCatalyst, <code>MauiVideoPlayer</code> derives from <code>UIView</code> and uses an <code>AVPlayer</code> to play videos (along with an <code>AVPlayerViewController</code> for the transport controls).</p>
</li>
<li>
<p>Resources/Raw - three embedded video files.</p>
<img alt="" border="0" height="320" data-original-height="263" data-original-width="253" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhz4l8j33jbjJNRQsuToYfM80h1Pb0z1gHFyiLTGdEy9LzBR0UiU4uhQYL7tdZfEnnaevin1xkzeZUkWbYNbRH4tJ8sRAKgW0LVO4s4wzTwFigkN1UKKZXVSR6_FTyY-P75tdA0WWVSfVY8NQc72nB5iKwy-Qelz3W1b8xBhaOobc9YES3OH7K4Bv9k/s320/Capture4.PNG"/>
<p>The video files have a build action of <em>MauiAsset</em>.</p>
</li><li>
<p>Views - pages that exercise the <code>Video</code> view. An event handler for the <code>Unloaded</code> event on each page invokes the <code>DisconnectHandler</code> override of the <code>VideoHandler</code>.</p>
</li>
</ul>
<p>A handler must be registered against its cross-platform view, and this takes place in <em>MauiProgram.cs</em> with the <code>ConfigureMauiHandler</code>/<code>AddHandler</code> methods.</p>
<h2 id="next-steps">Next steps</h2>
<p>There are currently two bugs I’m aware of in the implementation. Firstly, on Android the video is meant to be centred on the page, but it insists on aligning itself to the top of the page. I have suspicions for why this is happening. Secondly, on iOS, when using a <code>Slider</code> as a custom positioning bar, the scale of the <code>Slider</code> isn’t updated at runtime when setting its <code>Maximum</code> property. This makes it impossible right now to use a <code>Slider</code> to control the video’s position. I’ve pin pointed this to a bug in .NET MAUI on iOS, and <a href="https://github.com/dotnet/maui/issues/9040">logged it</a>.</p>
<p>I’m planning on turning this into an <a href="https://docs.microsoft.com/samples/browse/?expanded=dotnet&amp;products=dotnet-maui">official sample</a> during August, and writing <a href="https://docs.microsoft.com/dotnet/maui/">official docs</a> on how to create custom controls using .NET MAUI handlers.</p>

